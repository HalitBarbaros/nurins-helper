<script>
/* ===============================
   PERFORMANCE + STATE
================================ */
const MAX_INITIAL_RENDER = 40;
const FEED_TIMEOUT = 6000; // ms
const SESSION_SEEN = JSON.parse(sessionStorage.getItem('seenLinks')) || [];
let feedErrors = 0;

/* ===============================
   SOURCE WEIGHTING
================================ */
const SOURCE_WEIGHT = {
  "Quanta": 5,
  "APS Physics": 5,
  "Symmetry": 5,
  "Carbon Brief": 5,
  "Stat News": 4,
  "MIT Tech Review": 4,
  "BBC Science": 4,
  "Scientific American": 4,
  "ScienceAlert": 3,
  "Phys.org": 3,
  "Futurism": 2
};

/* ===============================
   PRIMARY SOURCE DETECTION
================================ */
function isPrimarySource(link) {
  return /nature\.com|science\.org|arxiv\.org|nih\.gov|doi\.org/i.test(link);
}

/* ===============================
   TRENDING LOGIC
================================ */
function computeTrending(articles) {
  const keywordMap = {};
  articles.forEach(a => {
    const words = a.title.toLowerCase().split(/\W+/);
    words.forEach(w => {
      if (w.length < 5) return;
      keywordMap[w] = (keywordMap[w] || 0) + 1;
    });
  });

  return articles
    .map(a => {
      const score = a.title
        .toLowerCase()
        .split(/\W+/)
        .reduce((s, w) => s + (keywordMap[w] || 0), 0);
      return { ...a, trendScore: score };
    })
    .sort((a, b) => b.trendScore - a.trendScore)
    .slice(0, 50);
}

/* ===============================
   FETCH ENGINE (FASTER)
================================ */
async function fetchFeed(feed) {
  const controller = new AbortController();
  setTimeout(() => controller.abort(), FEED_TIMEOUT);

  try {
    const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(feed.url)}`;
    const res = await fetch(proxy, { signal: controller.signal });
    const xml = await res.text();
    const data = new DOMParser().parseFromString(xml, "text/xml");

    const items = [...data.querySelectorAll("item, entry")];
    const cutoff = new Date(Date.now() - 7 * 86400000);

    return items.map(item => {
      const pub = item.querySelector("pubDate, published");
      if (!pub) return null;
      const time = new Date(pub.textContent);
      if (time < cutoff) return null;

      const link = item.querySelector("link")?.textContent ||
                   item.querySelector("link")?.getAttribute("href");

      return {
        category: feed.category,
        source: feed.name,
        title: item.querySelector("title")?.textContent || "",
        link,
        time,
        desc: (item.querySelector("description, summary, content")?.textContent || "")
              .replace(/<[^>]+>/g, "")
              .slice(0, 160) + "...",
        img: null
      };
    }).filter(Boolean);
  } catch {
    feedErrors++;
    return [];
  }
}

/* ===============================
   INIT (INCREMENTAL RENDER)
================================ */
async function init() {
  document.getElementById('loading').innerText = "Loading feeds‚Ä¶";
  allArticles = [];
  feedErrors = 0;

  const feedPromises = feeds.map(feed =>
    fetchFeed(feed).then(items => {
      allArticles.push(...items);
      renderPartial();
    })
  );

  await Promise.all(feedPromises);

  allArticles.sort((a, b) => {
    const wA = SOURCE_WEIGHT[a.source] || 1;
    const wB = SOURCE_WEIGHT[b.source] || 1;
    return (b.time - a.time) + (wB - wA) * 3600000;
  });

  document.getElementById('loading').style.display = "none";

  if (feedErrors) {
    showToast(`${feedErrors} feeds failed to load`);
  }
}

/* ===============================
   PARTIAL RENDER
================================ */
function renderPartial() {
  renderGrid(allArticles.slice(0, MAX_INITIAL_RENDER));
}

/* ===============================
   ANGLE BUILDER
================================ */
function buildAngle(news) {
  const text = `
What happened:
${news.title}

Why it matters:
[Why this changes understanding, policy, or impact]

What‚Äôs new:
[What is genuinely new here]

Source:
${news.source}
${news.link}
`;
  navigator.clipboard.writeText(text);
  showToast("Angle template copied");
}

/* ===============================
   RENDER
================================ */
function renderGrid(articles) {
  const grid = document.getElementById('news-grid');
  grid.innerHTML = "";

  const now = Date.now();

  articles.forEach(news => {
    const hoursOld = (now - news.time) / 3600000;
    const fresh = hoursOld < 12;
    const seen = SESSION_SEEN.includes(news.link);

    const card = document.createElement('div');
    card.className = `news-card ${fresh ? 'is-fresh' : ''}`;
    if (seen) card.style.opacity = "0.6";

    card.innerHTML = `
      <div class="card-image">
        ${isPrimarySource(news.link) ? `<div class="fresh-badge">PRIMARY</div>` : ""}
        <div class="category-badge">${news.category}</div>

        <div class="action-group">
          <button class="icon-btn" onclick="buildAngle(${JSON.stringify(news).replace(/"/g, '&quot;')})">üìù</button>
          <button class="icon-btn" onclick="copyLink('${news.link}')">‚ßâ</button>
          <button class="icon-btn star-btn ${favorites.some(f=>f.link===news.link)?'is-saved':''}" onclick="toggleFavorite('${news.link}')">‚òÖ</button>
        </div>
      </div>

      <div class="card-content">
        <div class="source-row">
          <span>${news.source}</span>
          <span>${new Date(news.time).toDateString()}</span>
        </div>
        <div class="headline">
          <a href="${news.link}" target="_blank" onclick="markSeen('${news.link}')">${news.title}</a>
        </div>
        <div class="snippet">${news.desc}</div>
      </div>
    `;

    grid.appendChild(card);
  });
}

/* ===============================
   SEEN TRACKING
================================ */
function markSeen(link) {
  if (!SESSION_SEEN.includes(link)) {
    SESSION_SEEN.push(link);
    sessionStorage.setItem('seenLinks', JSON.stringify(SESSION_SEEN));
  }
}

/* ===============================
   START
================================ */
init();
</script>
